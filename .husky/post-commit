#!/bin/sh

# ============================================================
# POST-COMMIT HOOK: Documentation Sync (SYNCHRONOUS)
# ============================================================
# Ensures documentation is 100% in sync with code after every
# commit. Runs SYNCHRONOUSLY - blocks until complete.
#
# Documentation is the offloaded context for all agents.
# Keeping it in sync is critical for context engineering.
#
# Skip conditions:
#   - Commit message starts with "docs(sync):" or "docs: sync documentation"
#   - DOC_SYNC_DISABLED=1 environment variable
# ============================================================

set -e  # Exit on error - this is intentional for synchronous behavior

# Allow disabling for special cases
if [ "$DOC_SYNC_DISABLED" = "1" ]; then
  echo "[post-commit] Doc sync disabled via DOC_SYNC_DISABLED=1"
  exit 0
fi

# Get project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Get commit info
COMMIT_SHA=$(git rev-parse --short HEAD)
COMMIT_MSG=$(git log -1 --format='%s' HEAD)

# ============================================================
# SKIP CONDITION: Prevent infinite loops
# ============================================================
case "$COMMIT_MSG" in
  docs\(sync\):*|"docs: sync documentation"*)
    echo "[post-commit] Skipping doc sync: already a doc sync commit"
    exit 0
    ;;
esac

# ============================================================
# SKIP CONDITION: Only pure documentation files changed
# ============================================================
# Skip doc-sync if NONE of the "source" files that need syncing changed.
#
# Source files that NEED doc sync (changes here → update docs):
#   - backend/app/*.py → README.md
#   - frontend/src/** → README.md
#   - Makefile, scripts/*.sh, docker-compose.yml → README.md
#   - extras/agents/*.md, extras/claude-skills/*.md → AGENTS.md
#   - .husky/*, .opencode/command/*.md → AGENTS.md
#
# Pure doc files (no sync needed - these ARE the docs):
#   - README.md, AGENTS.md, docs/**, .claude/**, .opencode/skill/**

CHANGED_FILES_CHECK=$(git diff-tree --no-commit-id --name-only -r HEAD 2>/dev/null || echo "")

if [ -n "$CHANGED_FILES_CHECK" ]; then
  # Pattern matches source files that trigger doc sync
  SOURCE_PATTERN='^(backend/app/.*\.py$|frontend/src/|Makefile$|docker-compose\.yml$|scripts/.*\.sh$|\.husky/|extras/agents/.*\.md$|extras/claude-skills/.*\.md$|\.opencode/command/.*\.md$)'
  
  if ! echo "$CHANGED_FILES_CHECK" | grep -qE "$SOURCE_PATTERN"; then
    echo "[post-commit] Skipping doc sync: only documentation files changed (no source files)"
    exit 0
  fi
fi

# ============================================================
# DOCUMENTATION SYNC
# ============================================================
echo ""
echo "============================================================"
echo "POST-COMMIT: Documentation Sync (synchronous)"
echo "============================================================"
echo "Commit: $COMMIT_SHA"
echo "Message: $COMMIT_MSG"
echo ""

# Get changed files for context
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD 2>/dev/null || echo "")

if [ -z "$CHANGED_FILES" ]; then
  echo "[post-commit] No files changed (merge commit?) - skipping"
  exit 0
fi

echo "Changed files:"
echo "$CHANGED_FILES" | sed 's/^/  - /'
echo ""

# ============================================================
# INVOKE DOCUMENTATION AGENT
# ============================================================
# Try opencode first, fall back to manual instructions

if command -v opencode >/dev/null 2>&1; then
  echo "[post-commit] Running documentation sync via opencode..."
  echo ""
  
  # Run SYNCHRONOUSLY in non-interactive mode - blocks until complete
  opencode run "/doc-sync HEAD" || {
    echo ""
    echo "[post-commit] WARNING: Doc sync encountered an issue"
    echo "[post-commit] Please run manually: /doc-sync or make doc-sync"
    # Don't fail the hook - doc sync issues shouldn't block workflow
    exit 0
  }
  
  echo ""
  echo "[post-commit] Documentation sync complete"
else
  echo "[post-commit] opencode not found"
  echo ""
  echo "To sync documentation manually, run one of:"
  echo "  /doc-sync"
  echo "  make doc-sync"
  echo ""
  echo "Install opencode for automatic doc sync:"
  echo "  npm install -g opencode"
fi

echo "============================================================"
