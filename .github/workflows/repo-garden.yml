name: Repository Gardening

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no changes)"
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze:
    name: Analyze Repository
    runs-on: ubuntu-latest
    outputs:
      has_issues: ${{ steps.check.outputs.has_issues }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for gardening opportunities
        id: check
        run: |
          issues=""
          
          # Check for empty directories
          empty_dirs=$(find . -type d -empty -not -path "./.git/*" | wc -l)
          if [ "$empty_dirs" -gt 0 ]; then
            issues="${issues}empty_dirs,"
          fi
          
          # Check for inconsistent file naming
          mixed_case=$(find frontend/src backend/app -name "*_*" -o -name "*-*" 2>/dev/null | head -5)
          if [ -n "$mixed_case" ]; then
            issues="${issues}naming,"
          fi
          
          # Check for orphaned files (no imports)
          # This is a simplified check
          
          if [ -n "$issues" ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Issues found: $issues"

  dead-code:
    name: Find Dead Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Find unused exports (frontend)
        run: |
          cd frontend
          if [ -f "package.json" ]; then
            pnpm install --frozen-lockfile || true
            npx ts-prune --error 2>/dev/null || echo "No dead code found or ts-prune not configured"
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Find unused code (backend)
        run: |
          cd backend
          pip install vulture
          vulture app/ --min-confidence 80 || echo "Dead code analysis complete"

  structure-check:
    name: Structure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate folder structure
        run: |
          echo "Checking required directories..."
          
          required_dirs=(
            "frontend/src"
            "backend/app"
            "constitution"
            ".claude/skills"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "❌ Missing required directory: $dir"
              exit 1
            fi
          done
          
          echo "✅ All required directories present"
          
      - name: Check for convention violations
        run: |
          # Check test file locations
          echo "Checking test file conventions..."
          
          # Frontend tests should be colocated or in __tests__
          # Backend tests should be in tests/
          
          misplaced=$(find backend/app -name "test_*.py" -o -name "*_test.py" 2>/dev/null)
          if [ -n "$misplaced" ]; then
            echo "⚠️ Test files found outside tests/ directory:"
            echo "$misplaced"
          fi
          
          echo "Structure check complete"

  create-report:
    name: Create Report
    runs-on: ubuntu-latest
    needs: [analyze, dead-code, structure-check]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate gardening report
        run: |
          cat << 'EOF' > gardening-report.md
          # Repository Gardening Report
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          **Workflow Run**: ${{ github.run_id }}
          
          ## Summary
          
          | Check | Status |
          |-------|--------|
          | Structure | ${{ needs.structure-check.result }} |
          | Dead Code | ${{ needs.dead-code.result }} |
          | Analysis | ${{ needs.analyze.result }} |
          
          ## Recommendations
          
          Review the workflow logs for specific recommendations.
          
          ---
          *Generated by repo-garden workflow*
          EOF
          
          cat gardening-report.md
          
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: gardening-report
          path: gardening-report.md
          retention-days: 30
